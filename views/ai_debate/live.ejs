<!DOCTYPE html>
<html>
<head>
    <title>GroBattle</title>
    <meta name="description" content="A beautiful, interactive AI debate tool. Enter your own debater names and topic, and watch two AI agents battle it out in real time.">
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f916.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        .subtopic-btn {
            padding: 0.8em 1.2em;
            background: linear-gradient(90deg, #7c3aed 0%, #a78bfa 100%);
            color: #fff;
            border: none;
            border-radius: 32px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 16px 0 #7c3aed33, 0 1.5px 8px #0002;
            transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
            letter-spacing: 0.5px;
        }

        .subtopic-btn:hover {
            background: linear-gradient(90deg, #a78bfa 0%, #7c3aed 100%);
            box-shadow: 0 4px 24px #a78bfa55, 0 2px 12px #7c3aed33;
        }

        .subtopic-btn:active {
            transform: scale(0.97);
        }


        body {
            font-family: 'Inter', Arial, sans-serif;
            background: linear-gradient(135deg, #181c2f 0%, #2d1a3a 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            position: relative;
        }
        #betaDebater {
            display: none !important;
        }
        #alphaDebater {
            display: none !important;
        }
        .siri-bg-anim {
            position: fixed;
            left: 0; bottom: 0; width: 100vw; height: 220px;
            z-index: 0;
            pointer-events: none;
            opacity: 0.7;
        }
        .ai-header {
            position: fixed;
            top: 0;
            left: 0;
            height: 64px;
            width: 100vw;
            display: flex;
            align-items: center;
            gap: 0.7em;
            padding: 0 2em;
            background: rgba(30, 30, 50, 0.7);
            backdrop-filter: blur(8px);
            z-index: 20;
            box-shadow: 0 2px 16px #7c3aed22;
            border-bottom: 1.5px solid #7c3aed33;
        }
        .ai-header-icon {
            font-size: 2.1em;
            filter: drop-shadow(0 0 8px #a78bfa88);
            margin-right: 0.2em;
        }
        .ai-header-title {
            font-size: 1.25em;
            font-weight: 700;
            color: #a78bfa;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px #7c3aed55;
        }
        .ai-container {
            margin-top: 56px;
            animation: fadeInMain 1.1s cubic-bezier(.4,2,.6,1);
        }
        @keyframes fadeInMain {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: none; }
        }
        .topic-form {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1em;
            margin: 0 auto 0.7em auto;
            max-width: 600px;
            border-radius: 32px;
            padding: 1.2em 2em;
            backdrop-filter: blur(16px);
        }
        .topic-form input[type="text"] {
            flex: 1;
            padding: 0.7em 1.2em;
            font-size: 1.2em;
            border-radius: 32px;
            border: none;
            outline: none;
            background: #23243a;
            color: #fff;
            box-shadow: 0 1px 4px #0002;
            font-weight: 500;
        }
        .topic-form button, .autoplay-btn, .stop-btn, #resetDebateBtn {
            padding: 0.8em 2.5em;
            background: linear-gradient(90deg, #7c3aed 0%, #a78bfa 100%);
            color: #fff;
            border: none;
            border-radius: 32px;
            font-size: 1.15em;
            cursor: pointer;
            font-weight: 700;
            box-shadow: 0 2px 16px 0 #7c3aed33, 0 1.5px 8px #0002;
            transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
            letter-spacing: 0.5px;
            min-width: 150px;
            min-height: 48px;
            display: inline-block;
            margin: 0 0.2em;
        }
        .topic-form button:active, .autoplay-btn:active, .stop-btn:active, #resetDebateBtn:active {
            transform: scale(0.97);
        }
        .topic-form button:disabled, .autoplay-btn:disabled, .stop-btn:disabled, #resetDebateBtn:disabled {
            background: #444a;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7;
        }
        .topic-form button:hover:not(:disabled), .autoplay-btn:hover:not(:disabled), .stop-btn:hover:not(:disabled),  #resetDebateBtn:hover:not(:disabled) {
            background: linear-gradient(90deg, #a78bfa 0%, #7c3aed 100%);
            box-shadow: 0 4px 24px #a78bfa55, 0 2px 12px #7c3aed33;
        }
        #debateTitle {
            text-align: center;
            margin: 0.5em 0 0.2em 0;
            color: #fff;
            text-shadow: 0 2px 16px #7c3aed99;
            font-size: 2.3em;
            letter-spacing: 1.5px;
            font-weight: 700;
        }
        .debate-announcement {
            text-align: center;
            font-size: 1.2em;
            margin-top: 0.2em;
            color: #bdbdfc;
            font-weight: 500;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 8px #7c3aed55;
        }
        .debate-status {
            text-align: center;
            font-size: 1.2em;
            margin: 1em 0 0.5em 0;
            color: #a78bfa;
            min-height: 1.5em;
            font-weight: 600;
            text-shadow: 0 2px 8px #7c3aed33;
            letter-spacing: 0.5px;
        }
        .center-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1em;
            margin-bottom: 0.7em;
        }
        .debate-card {
            background: rgba(30, 30, 50, 0.7);
            border-radius: 32px;
            box-shadow: 0 8px 48px 0 #000a, 0 0 32px #7c3aed33;
            padding: 1.2em 1em 1em 1em;
            margin: 0 auto;
            max-width: min(1200px, 98vw, max-content);
            min-width: 320px;
            width: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            backdrop-filter: blur(24px);
            border: 2.5px solid #7c3aed55;
            animation: fadeInCard 1.2s 0.2s cubic-bezier(.4,2,.6,1) backwards;
            min-height: 340px;
            max-height: 68vh;
            overflow: hidden;
        }
        @keyframes fadeInCard {
            from { opacity: 0; transform: scale(0.97) translateY(30px); }
            to { opacity: 1; transform: none; }
        }
        .debate-battle {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 2em;
            margin: 0.5em auto 0 auto;
            max-width: 1100px;
            position: relative;
            width: 100%;
            height: 340px;
        }
        .debater {
            flex: 1;
            background: rgba(40, 40, 60, 0.85);
            border-radius: 40px;
            box-shadow: 0 2px 24px #7c3aed22, 0 0 32px #7c3aed22;
            padding: 1.2em 1.2em 1.2em 1.2em;
            min-height: 260px;
            max-height: 340px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            border: 2.5px solid #7c3aed55;
            transition: box-shadow 0.3s, border 0.3s, transform 0.2s;
            overflow: hidden;
        }
        .debater:hover, .debater:focus-within {
            box-shadow: 0 0 64px #a78bfa55, 0 0 128px #7c3aed33;
            border: 3px solid #a78bfa;
            transform: translateY(-4px) scale(1.02);
        }
        .debater.speaking {
            box-shadow: 0 0 48px #a78bfaee, 0 0 96px #7c3aedcc;
            border: 3px solid #a78bfa;
        }
        .debater h2 {
            margin-bottom: 1em;
            color: #fff;
            letter-spacing: 0.5px;
            font-size: 1.2em;
            text-shadow: 0 2px 8px #7c3aed33;
            font-weight: 600;
        }
        .debate-turn {
            margin-bottom: 1.5em;
            width: 100%;
            text-align: left;
            background: rgba(60, 60, 90, 0.85);
            border-radius: 18px;
            padding: 1em 1.2em;
            position: relative;
            box-shadow: 0 1px 8px #7c3aed22;
            color: #fff;
            font-size: 1.13em;
            font-weight: 500;
            letter-spacing: 0.2px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInTurn 0.7s forwards;
            transition: background 0.3s, box-shadow 0.3s, border 0.3s;
        }
        @keyframes fadeInTurn {
            to {
                opacity: 1;
                transform: none;
            }
        }
        .avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7c3aed 0%, #a78bfa 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.2em;
            margin-bottom: 0.7em;
            border: 6px solid #fff2;
            box-shadow: 0 0 32px #a78bfa88, 0 0 64px #7c3aed44;
            color: #fff;
            text-shadow: 0 2px 12px #7c3aed99;
            transition: box-shadow 0.3s, border 0.3s, transform 0.2s;
            animation: avatarPulse 2s infinite alternate;
            position: relative;
            overflow: visible;
        }
        .debater.speaking .avatar {
            box-shadow: 0 0 64px #a78bfa, 0 0 128px #7c3aed;
            border: 6px solid #a78bfa;
            animation: avatarPulseActive 1s infinite alternate;
        }
        .avatar:hover, .avatar:focus {
            box-shadow: 0 0 96px #a78bfa, 0 0 192px #7c3aed;
            border: 6px solid #a78bfa;
            transform: scale(1.08) rotate(-2deg);
        }
        .avatar::after {
            content: '';
            position: absolute;
            left: 50%; top: 50%;
            transform: translate(-50%, -50%);
            width: 120px; height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle, #a78bfa33 0%, transparent 70%);
            opacity: 0.7;
            z-index: 0;
            pointer-events: none;
        }
        @keyframes avatarPulse {
            0% { box-shadow: 0 0 32px #a78bfa88, 0 0 64px #7c3aed44; }
            100% { box-shadow: 0 0 48px #a78bfa99, 0 0 96px #7c3aed55; }
        }
        @keyframes avatarPulseActive {
            0% { box-shadow: 0 0 64px #a78bfa, 0 0 128px #7c3aed; }
            100% { box-shadow: 0 0 96px #a78bfa, 0 0 192px #7c3aed; }
        }
        .center-loader {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .spinner {
            border: 5px solid #23243a;
            border-top: 5px solid #7c3aed;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 0.5em;
            box-shadow: 0 0 16px #a78bfa55;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .loader-label {
            color: #a78bfa;
            font-weight: 700;
            font-size: 1.2em;
            text-shadow: 0 2px 8px #7c3aed33;
            letter-spacing: 0.5px;
        }
        .winner-box {
            text-align: center;
            margin-top: 1em;
            font-size: 1.5em;
            color: #10b981;
            font-weight: bold;
            text-shadow: 0 2px 8px #10b98133;
            letter-spacing: 0.5px;
            background: rgba(16, 185, 129, 0.08);
            border-radius: 18px;
            padding: 1.1em 2em;
            max-width: 420px;
            margin-left: auto;
            margin-right: auto;
            word-break: break-word;
            box-shadow: 0 2px 16px #10b98122;
            line-height: 1.4;
        }
        @keyframes popWinner {
            0% { opacity: 0; transform: scale(0.7); }
            70% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        @media (max-width: 600px) {
            .winner-box {
                font-size: 1.1em;
                padding: 0.8em 0.7em;
                max-width: 98vw;
            }
        }
        .confetti {
            position: absolute;
            left: 50%;
            top: 0;
            width: 100%;
            height: 0;
            pointer-events: none;
            z-index: 100;
        }
        @media (max-width: 900px) {
            .debate-battle { flex-direction: column; gap: 0.7em; height: 340px; }
            .debate-card { padding: 0.7em 0.2em; max-height: 80vh; }
            .debater { border-radius: 24px; min-height: 120px; max-height: 160px; }
            .debater-scroll { max-height: 60px; }
            .avatar, .avatar-gif { width: 48px; height: 48px; }
        }
        @media (max-width: 600px) {
            .debate-card { max-height: 92vh; }
            .debate-battle { height: 220px; }
            .debater { max-height: 110px; }
            .debater-scroll { max-height: 36px; }
        }
        .ai-footer {
            width: 100vw;
            text-align: center;
            padding: 1.2em 0 1.2em 0;
            color: #bdbdfc;
            font-size: 1.08em;
            font-weight: 500;
            letter-spacing: 0.5px;
            background: rgba(30, 30, 50, 0.7);
            backdrop-filter: blur(8px);
            position: fixed;
            left: 0;
            bottom: 0;
            z-index: 10;
            border-top: 1.5px solid #7c3aed55;
            box-shadow: 0 -2px 16px #7c3aed22;
        }
        .onboarding-modal {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(30,30,50,0.85);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s;
        }
        .onboarding-content {
            background: rgba(255,255,255,0.12);
            border-radius: 24px;
            box-shadow: 0 8px 32px #7c3aed33;
            padding: 2.5em 2.5em 2em 2.5em;
            text-align: center;
            color: #fff;
            max-width: 400px;
            font-size: 1.15em;
            backdrop-filter: blur(16px);
            border: 2px solid #a78bfa55;
        }
        .onboarding-content h2 {
            margin-top: 0;
            color: #a78bfa;
            font-size: 1.4em;
            font-weight: 700;
        }
        .onboarding-content button {
            margin-top: 2em;
            padding: 0.7em 2.5em;
            background: linear-gradient(90deg, #7c3aed 0%, #a78bfa 100%);
            color: #fff;
            border: none;
            border-radius: 32px;
            font-size: 1.1em;
            cursor: pointer;
            font-weight: 700;
            box-shadow: 0 2px 16px 0 #7c3aed33, 0 1.5px 8px #0002;
            transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
            letter-spacing: 0.5px;
            min-width: 150px;
            min-height: 48px;
            display: inline-block;
        }
        .onboarding-content button:hover {
            background: linear-gradient(90deg, #a78bfa 0%, #7c3aed 100%);
            box-shadow: 0 4px 24px #a78bfa55, 0 2px 12px #7c3aed33;
        }
        .onboarding-content button:active, .onboarding-content button:focus {
            outline: 2px solid #a78bfa;
            outline-offset: 2px;
        }
        .round-indicator {
            text-align: center;
            color: #bdbdfc;
            font-size: 1.15em;
            font-weight: 600;
            margin-bottom: 0.2em;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 8px #7c3aed33;
        }
        .debater-scroll {
            max-height: 220px;
            overflow-y: auto;
            width: 100%;
            padding-right: 4px;
        }
        .reflection-turn {
            background: linear-gradient(90deg, #a78bfa33 0%, #7c3aed22 100%);
            border: 2px dashed #a78bfa;
            color: #a78bfa;
            font-style: italic;
            font-size: 1.08em;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            padding: 1em 1.2em;
            border-radius: 18px;
            box-shadow: 0 1px 8px #7c3aed22;
            text-align: center;
        }
        .loader-dots {
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5em;
        }
        .loader-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin: 0 2px;
            background: #a78bfa;
            border-radius: 50%;
            opacity: 0.7;
            animation: loaderDotAnim 1.2s infinite both;
        }
        .loader-dot:nth-child(2) { animation-delay: 0.2s; }
        .loader-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes loaderDotAnim {
            0%, 80%, 100% { opacity: 0.7; transform: scale(1); }
            40% { opacity: 1; transform: scale(1.3); }
        }
        .ai-description {
            width: 100vw;
            text-align: center;
            margin-top: 80px;
            margin-bottom: 0.7em;
            background: none;
            font-size: 1.5em;
            font-weight: 500;
            letter-spacing: 1px;
            line-height: 1.1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .ai-description-title {
            background: linear-gradient(90deg, #a78bfa 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            font-size: 1.5em;
            font-weight: 600;
            letter-spacing: 1px;
            text-shadow: 0 1px 8px #7c3aed22;
            margin-bottom: 0.1em;
        }
        .ai-description-divider {
            width: 40px;
            height: 2px;
            background: linear-gradient(90deg, #a78bfa 0%, #7c3aed 100%);
            border-radius: 2px;
            margin: 0.3em auto 0.4em auto;
            opacity: 0.5;
        }
        .ai-description-sub {
            display: block;
            font-size: 1em;
            font-weight: 400;
            color: #bdbdfc;
            font-style: italic;
            margin-top: 0.1em;
            letter-spacing: 0.1px;
            text-shadow: 0 1px 4px #7c3aed11;
            max-width: 480px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.3;
        }
        .debate-progress-bar-container {
            position: fixed;
            left: 0;
            bottom: 64px;
            width: 100vw;
            height: 10px;
            background: #23243a;
            border-radius: 0;
            box-shadow: 0 -1px 8px #7c3aed22;
            overflow: hidden;
            z-index: 50;
            display: flex;
            align-items: center;
        }
        .debate-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #a78bfa 0%, #7c3aed 100%);
            border-radius: 8px;
            transition: width 0.5s cubic-bezier(.4,2,.6,1);
            box-shadow: 0 0 12px #a78bfa55;
        }
        .status-connected {
            color: #10b981;
            font-weight: bold;
        }
        .debater-link-box {
            display: flex;
            flex-direction: column;
            gap: 1em;
            align-items: center;
            padding: 1.5em;
            background: #23243a;
            border-radius: 16px;
            box-shadow: inset 0 0 12px #7c3aed33;
            transition: box-shadow 0.3s;
        }

        .debater-link-box:hover {
            box-shadow: inset 0 0 24px #a78bfa55;
        }

        .debater-link-title {
            display: flex;
            align-items: center;
            gap: 0.5em;
            font-size: 1.2em;
            font-weight: 700;
            color: #a78bfa;
            text-shadow: 0 1px 8px #7c3aed55;
            letter-spacing: 0.5px;
        }

        .debater-link-box input[type="text"] {
            width: 100%;
            padding: 0.7em 1em;
            font-size: 1em;
            border-radius: 12px;
            border: 2px solid #7c3aed55;
            outline: none;
            background: #181c2f;
            color: #fff;
            box-shadow: 0 1px 4px #0002;
            font-weight: 500;
            transition: border-color 0.2s;
        }

        .debater-link-box input[type="text"]:focus {
            border-color: #a78bfa;
            box-shadow: 0 0 12px #a78bfa55;
        }

        .debater-link-buttons {
            display: flex;
            gap: 0.5em;
        }

        .debater-link-buttons button {
            padding: 0.7em 1.5em;
            font-size: 0.9em;
        }

        .debater-status-text {
            font-weight: 600;
            margin-top: 0.5em;
            color: #e74c3c;
            transition: color 0.3s;
        }

        .status-connected {
            color: #2ecc71;
        }
        @media (max-width: 768px) {
            #debateTitle {
                font-size: 1.8em;
            }
            .topic-form {
                flex-direction: column;
                padding: 1.2em 1em;
            }
            .topic-form input[type="text"] {
                width: 100%;
            }
            .topic-form button {
                width: 100%;
                min-width: unset;
                font-size: 1em;
            }
            .center-controls {
                flex-direction: column;
                gap: 0.5em;
            }
            .center-controls button {
                width: 90%;
            }
            .debater-link-box {
                padding: 1em;
            }
            .debater-link-buttons {
                flex-direction: column;
                width: 100%;
                gap: 0.7em;
            }
            .debater-link-buttons button {
                width: 100%;
                font-size: 0.8em;
                padding: 0.7em;
            }
            #viewLinks {
                flex-direction: column;
                padding: 1em;
                margin: 0.5em auto;
            }
            .debate-battle {
                flex-direction: column;
                gap: 0.7em;
                height: auto;
            }
            .debater {
                min-height: 120px;
                max-height: 160px;
            }
            .debater-scroll {
                max-height: 60px;
            }
            .avatar, .avatar-gif {
                width: 48px;
                height: 48px;
            }
            .debate-turn {
                font-size: 1em;
            }
            .loader-label {
                font-size: 1em;
            }
            .ai-footer, .ai-header {
                padding: 0 1em;
            }
            .ai-header-title {
                font-size: 1em;
            }
            .ai-header-icon {
                font-size: 1.5em;
            }
            .ai-description-title {
                font-size: 1.2em;
            }
            .ai-description-sub {
                font-size: 0.9em;
            }
        }
Â  Â  </style>
</head>
<body>
Â  Â  <div id="welcomeBanner" style="display:none;position:fixed;top:0;left:0;width:100vw;z-index:100;background:linear-gradient(90deg,#7c3aed 0%,#a78bfa 100%);color:#fff;text-align:center;padding:1em 0;font-size:1.1em;font-weight:600;box-shadow:0 2px 16px #7c3aed33;letter-spacing:0.5px;">
Â  Â  Â  Â  Welcome to Debate. Experience a live, intelligent debate on any topic you choose.
Â  Â  Â  Â  <button id="closeWelcomeBanner" style="margin-left:1.5em;background:rgba(255,255,255,0.15);border:none;border-radius:16px;padding:0.3em 1.2em;color:#fff;font-weight:600;cursor:pointer;font-size:1em;">Dismiss</button>
Â  Â  </div>
Â  Â  <div id="welcomeGifContainer" style="display:none;position:fixed;top:24px;left:50%;transform:translateX(-50%);z-index:101;text-align:center;">
Â  Â  Â  Â  <img src="/images/voice_start.gif" alt="Welcome Voice Animation" style="width:90px;height:90px;border-radius:50%;box-shadow:0 2px 24px #a78bfa88;" />
Â  Â  </div>
Â  Â  <header class="ai-header">
Â  Â  Â  Â  <img src="/images/logo.jpg" alt="Gro Battle Logo" style="width:38px;height:38px;border-radius:50%;object-fit:cover;box-shadow:0 2px 8px #7c3aed44;margin-right:0.7em;vertical-align:middle;" />
Â  Â  Â  Â  <span class="ai-header-title">GroBattle</span>
Â  Â  </header>
Â  Â  <svg class="siri-bg-anim" viewBox="0 0 1440 220" fill="none" xmlns="http://www.w3.org/2000/svg">
Â  Â  Â  Â  <defs>
Â  Â  Â  Â  Â  Â  <linearGradient id="siriwave" x1="0" y1="0" x2="1440" y2="220" gradientUnits="userSpaceOnUse">
Â  Â  Â  Â  Â  Â  Â  Â  <stop stop-color="#a78bfa" stop-opacity="0.7"/>
Â  Â  Â  Â  Â  Â  Â  Â  <stop offset="1" stop-color="#7c3aed" stop-opacity="0.4"/>
Â  Â  Â  Â  Â  Â  </linearGradient>
Â  Â  Â  Â  </defs>
Â  Â  Â  Â  <path d="M0 180 Q 360 120 720 180 T 1440 180 V 220 H 0 Z" fill="url(#siriwave)">
Â  Â  Â  Â  Â  Â  <animate attributeName="d" dur="7s" repeatCount="indefinite"
Â  Â  Â  Â  Â  Â  Â  Â  values="M0 180 Q 360 120 720 180 T 1440 180 V 220 H 0 Z;
Â  Â  Â  Â  Â  Â  Â  Â  M0 200 Q 360 160 720 200 T 1440 200 V 220 H 0 Z;
Â  Â  Â  Â  Â  Â  Â  Â  M0 180 Q 360 120 720 180 T 1440 180 V 220 H 0 Z" />
Â  Â  Â  Â  </path>
Â  Â  </svg>
Â  Â  <div class="ai-container">
Â  Â  Â  Â  <div class="debate-progress-bar-container">
Â  Â  Â  Â  Â  Â  <div class="debate-progress-bar" id="debateProgressBar" style="width: 0%"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="topicExplanation" style="display:none;margin:0 auto 0.7em auto;max-width:700px;text-align:center;font-size:1.13em;color:#bdbdfc;background:rgba(60,60,90,0.5);border-radius:18px;padding:0.7em 1.2em;box-shadow:0 2px 12px #7c3aed22;"></div>
Â  Â  Â  Â  <form class="topic-form" id="topicForm">
Â  Â  Â  Â  Â  Â  <input type="text" id="alphaNameInput" placeholder="Alpha name..." required value="Alpha">
Â  Â  Â  Â  Â  Â  <input type="text" id="betaNameInput" placeholder="Beta name..." required value="Beta">
Â  Â  Â  Â  Â  Â  <input type="text" id="topicInput" placeholder="Enter debate topic..." required value="<%= topic %>">
Â  Â  Â  Â  Â  Â  <input type="number" id="roundsInput" placeholder="Rounds" min="1" max="10" value="3" required style="width: 90px; font-size: 1.1em; border-radius: 32px; border: none; outline: none; background: #23243a; color: #fff; font-weight: 500; padding: 0.7em 1.2em; text-align: center;">
Â  Â  Â  Â  Â  Â  <button type="submit">Set Topic</button>
Â  Â  Â  Â  </form>
Â  Â  Â  Â  
Â  Â  Â  Â  <h1 id="debateTitle">Gro Battle: <span id="alphaName">Alpha</span> vs <span id="betaName">Beta</span> â€” <span id="debateTopic"><%= topic %></span></h1>
Â  Â  Â  Â  <div class="debate-announcement"><span id="alphaName2">Alpha</span> vs <span id="betaName2">Beta</span> are battling</div>
Â  Â  Â  Â  <div class="debate-status" id="debateStatus"></div>
Â  Â  Â  Â  <div class="center-controls">
Â  Â  Â  Â  Â  Â  <button class="autoplay-btn" id="startDebateBtn">Start Debate</button>
Â  Â  Â  Â  Â  Â  <button class="stop-btn" id="stopDebateBtn" disabled>Stop Debate</button>
Â  Â  Â  Â  Â  Â  <button id="resetDebateBtn" aria-label="Reset Debate">ğŸ”„ Reset</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="onboardingModal" class="onboarding-modal" style="display: none;">
Â  Â  Â  Â  Â  Â  <div class="onboarding-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h2>Welcome to GroBattle!</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <p>Enter custom names and a topic, then click <b>Start Debate</b> to watch two AI agents battle it out in real time.<br><br>Click <b>Stop Debate</b> at any time, or scroll to review previous rounds.</p>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="closeOnboardingBtn">Got it!</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="debate-card">
Â  Â  Â  Â  Â  Â  <div class="round-indicator" id="roundIndicator">Round 1 of 3</div>
Â  Â  Â  Â  Â  Â  <div class="debate-battle">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="debater" id="alphaDebater">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="avatar" title="AI Alpha" id="alphaAvatar">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="avatar-icon" id="alphaAvatarIcon">ğŸ¤–</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="/images/voice_start.gif" id="alphaAvatarGif" class="avatar-gif" alt="Alpha speaking" style="display:none;width:64px;height:64px;border-radius:50%;object-fit:cover;" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="alphaTitle">Alpha (Pro)</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="alphaTurns" class="debater-scroll"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="center-loader" id="centerLoader" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="spinner"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="loader-label" id="loaderLabel">AI is thinking... <span class="loader-dots"><span class="loader-dot"></span><span class="loader-dot"></span><span class="loader-dot"></span></span></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="debater" id="betaDebater">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="avatar" title="AI Beta" id="betaAvatar">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="avatar-icon" id="betaAvatarIcon">ğŸ§‘â€ğŸ’¼</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="/images/voice_start.gif" id="betaAvatarGif" class="avatar-gif" alt="Beta speaking" style="display:none;width:64px;height:64px;border-radius:50%;object-fit:cover;" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="betaTitle">Beta (Con)</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="betaTurns" class="debater-scroll"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="reflectionTurns"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="viewLinks" style="margin-top: 1rem;">
Â  Â  Â  Â  Â  Â  Â  <div id="viewLinks" style="margin: 1rem auto; max-width: 800px; display: flex; flex-direction: column; gap: 1.5em; padding: 1.5em; background: rgba(30, 30, 50, 0.7); border-radius: 24px; border: 2px solid #7c3aed55; box-shadow: 0 4px 24px #7c3aed33, 0 2px 12px #0002; backdrop-filter: blur(16px);">
Â  Â  Â  Â  Â  <div class="debater-link-box">
Â  Â  Â  Â  Â  Â  Â  <div class="debater-link-title">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="avatar-icon">ğŸ¤–</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Alpha View</strong>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <input type="text" id="alphaLink" readonly />
Â  Â  Â  Â  Â  Â  Â  <div class="debater-link-buttons">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="subtopic-btn copy-btn" onclick="copyLink('alpha')">Copy Link</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="subtopic-btn open-btn" onclick="openAlpha()">Open View</button>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <span id="alphaStatus" class="debater-status-text">âŒ Not connected</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="debater-link-box">
Â  Â  Â  Â  Â  Â  Â  <div class="debater-link-title">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="avatar-icon">ğŸ§‘â€ğŸ’¼</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <strong>Beta View</strong>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <input type="text" id="betaLink" readonly />
Â  Â  Â  Â  Â  Â  Â  <div class="debater-link-buttons">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="subtopic-btn copy-btn" onclick="copyLink('beta')">Copy Link</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="subtopic-btn open-btn" onclick="openBeta()">Open View</button>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <span id="betaStatus" class="debater-status-text">âŒ Not connected</span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="subtopicModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:200;background:rgba(30,30,50,0.85);backdrop-filter:blur(8px);align-items:center;justify-content:center;">
Â  Â  Â  Â  Â  Â  <div style="background:rgba(255,255,255,0.13);border-radius:24px;box-shadow:0 8px 32px #7c3aed33;padding:2.2em 2.2em 1.7em 2.2em;text-align:center;color:#fff;max-width:420px;margin:auto;position:relative;">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="font-size:1.4em;font-weight:700;color:#a78bfa;margin-bottom:1em;text-shadow:0 2px 8px #7c3aed55;">Choose a Subtopic</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="subtopicList" style="display:flex;flex-direction:column;gap:0.8em;"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="winner-box" id="winnerBox" style="display:none;"></div>
Â  Â  Â  Â  <canvas class="confetti" id="confettiCanvas"></canvas>
Â  Â  Â  Â  <div id="winnerModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:200;background:rgba(30,30,50,0.85);backdrop-filter:blur(8px);align-items:center;justify-content:center;">
Â  Â  Â  Â  Â  Â  <div style="background:rgba(255,255,255,0.13);border-radius:24px;box-shadow:0 8px 32px #7c3aed33;padding:2.2em 2.2em 1.7em 2.2em;text-align:center;color:#fff;max-width:340px;margin:auto;position:relative;">
Â  Â  Â  Â  Â  Â  Â  Â  <img src='https://media.giphy.com/media/26ufnwz3wDUli7GU0/giphy.gif' alt='Confetti celebration' style='width:90px;height:90px;object-fit:contain;margin-bottom:0.5em;border-radius:18px;box-shadow:0 2px 16px #a78bfa55;'>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="winnerModalTitle" style="font-size:1.5em;font-weight:700;color:#10b981;text-shadow:0 2px 8px #10b98133;letter-spacing:0.5px;margin-bottom:0.5em;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="winnerModalReason" style="font-size:1.08em;color:#bdbdfc;margin-bottom:0.7em;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="winnerModalRatings" style="font-size:1em;color:#a78bfa;margin-bottom:1.2em;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="closeWinnerModal" style="padding:0.6em 2em;background:linear-gradient(90deg,#7c3aed 0%,#a78bfa 100%);color:#fff;border:none;border-radius:32px;font-size:1.1em;cursor:pointer;font-weight:700;box-shadow:0 2px 16px 0 #7c3aed33,0 1.5px 8px #0002;transition:background 0.2s,box-shadow 0.2s,transform 0.1s;letter-spacing:0.5px;">Close</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <footer class="ai-footer">Built By GroBro</footer>
Â  Â  <script src="/socket.io/socket.io.js"></script>
Â  Â  
Â  Â  <script>
Â  Â  Â  Â  let betaWindow = null;
Â  Â  Â  Â  let alphaWindow = null; 
Â  Â  Â  Â  let isDebatePaused = false;
Â  Â  Â  Â  let newTopic = null;
Â  Â  Â  Â  let topic = decodeURIComponent('<%= encodeURIComponent(topic) %>');
Â  Â  Â  Â  let alphaName = 'Alpha';
Â  Â  Â  Â  let betaName = 'Beta';
Â  Â  Â  Â  let history = [];
Â  Â  Â  Â  let step = 0;
Â  Â  Â  Â  let rounds = 3;
Â  Â  Â  Â  let maxSteps = 6; // 3 rounds (A, B, A, B, ...)
Â  Â  Â  Â  let responseTimeout = null;
Â  Â  Â  Â  const isModerator = !window.opener; // assumes only main tab opens Alpha/Beta views
Â  Â  Â  Â  const alphaTurns = document.getElementById('alphaTurns');
Â  Â  Â  Â  const betaTurns = document.getElementById('betaTurns');
Â  Â  Â  Â  const statusDiv = document.getElementById('debateStatus');
Â  Â  Â  Â  const startBtn = document.getElementById('startDebateBtn');
Â  Â  Â  Â  const stopBtn = document.getElementById('stopDebateBtn');
Â  Â  Â  Â  const centerLoader = document.getElementById('centerLoader');
Â  Â  Â  Â  const loaderLabel = document.getElementById('loaderLabel');
Â  Â  Â  Â  const winnerBox = document.getElementById('winnerBox');
Â  Â  Â  Â  const topicForm = document.getElementById('topicForm');
Â  Â  Â  Â  const topicInput = document.getElementById('topicInput');
Â  Â  Â  Â  const alphaNameInput = document.getElementById('alphaNameInput');
Â  Â  Â  Â  const betaNameInput = document.getElementById('betaNameInput');
Â  Â  Â  Â  const debateTitle = document.getElementById('debateTitle');
Â  Â  Â  Â  const alphaNameSpan = document.getElementById('alphaName');
Â  Â  Â  Â  const betaNameSpan = document.getElementById('betaName');
Â  Â  Â  Â  const alphaNameSpan2 = document.getElementById('alphaName2');
Â  Â  Â  Â  const betaNameSpan2 = document.getElementById('betaName2');
Â  Â  Â  Â  const debateTopicSpan = document.getElementById('debateTopic');
Â  Â  Â  Â  const alphaDebater = document.getElementById('alphaDebater');
Â  Â  Â  Â  const betaDebater = document.getElementById('betaDebater');
Â  Â  Â  Â  const alphaTitle = document.getElementById('alphaTitle');
Â  Â  Â  Â  const betaTitle = document.getElementById('betaTitle');
Â  Â  Â  Â  let sessionRestored = false;
Â  Â  Â  Â  const alphaAvatar = document.getElementById('alphaAvatar');
Â  Â  Â  Â  const betaAvatar = document.getElementById('betaAvatar');
Â  Â  Â  Â  let stopped = false;
Â  Â  Â  Â  const roundIndicator = document.getElementById('roundIndicator');
Â  Â  Â  Â  const reflectionTurns = document.getElementById('reflectionTurns');
Â  Â  Â  Â  // Onboarding modal logic
Â  Â  Â  Â  const onboardingModal = document.getElementById('onboardingModal');
Â  Â  Â  Â  const closeOnboardingBtn = document.getElementById('closeOnboardingBtn');
Â  Â  Â  Â  if (!localStorage.getItem('aiDebateOnboarded')) {
Â  Â  Â  Â  Â  Â  onboardingModal.style.display = 'flex';
Â  Â  Â  Â  }
Â  Â  Â  Â  closeOnboardingBtn.addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  onboardingModal.style.display = 'none';
Â  Â  Â  Â  Â  Â  localStorage.setItem('aiDebateOnboarded', '1');
Â  Â  Â  Â  });
Â  Â  Â  Â  // document.getElementById('humanControls').style.display = 'flex';

Â  Â  Â  Â  const params = new URLSearchParams(window.location.search);
Â  Â  Â  Â  let sessionId;

Â  Â  Â  Â  if (params.get('session')) {
Â  Â  Â  Â  Â  Â  sessionId = params.get('session'); // reuse existing session
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Create new only after topic submission
Â  Â  Â  Â  Â  Â  sessionId = null;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  let alphaReady = false;
Â  Â  Â  Â  let betaReady = false;

Â  Â  Â  Â  const socket = io();
Â  Â  Â  Â  socket.emit('joinSession', sessionId);

Â  Â  Â  Â  // Listen for readiness updates
Â  Â  Â  Â  socket.on('statusUpdate', (status) => {
Â  Â  Â  Â  Â  Â  console.log('Received statusUpdate:', status);
Â  Â  Â  Â  Â  Â  alphaReady = status.alphaReady;
Â  Â  Â  Â  Â  Â  betaReady = status.betaReady;

Â  Â  Â  Â  Â  Â  const alphaStatusSpan = document.getElementById('alphaStatus');
Â  Â  Â  Â  Â  Â  const betaStatusSpan = document.getElementById('betaStatus');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  alphaStatusSpan.textContent = alphaReady ? 'âœ… Connected' : 'âŒ Not connected';
Â  Â  Â  Â  Â  Â  alphaStatusSpan.classList.toggle('status-connected', alphaReady);
Â  Â  Â  Â  Â  Â  alphaStatusSpan.dataset.connected = alphaReady;

Â  Â  Â  Â  Â  Â  betaStatusSpan.textContent = betaReady ? 'âœ… Connected' : 'âŒ Not connected';
Â  Â  Â  Â  Â  Â  betaStatusSpan.classList.toggle('status-connected', betaReady);
Â  Â  Â  Â  Â  Â  betaStatusSpan.dataset.connected = betaReady;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Enable the start button if both are ready
Â  Â  Â  Â  Â  Â  if (alphaReady && betaReady) {
Â  Â  Â  Â  Â  Â  Â  Â  startBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  setDebateStatus('Ready to begin! Click "Start Debate" to begin.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  socket.on('turnDone', ({ role }) => {
Â  Â  Â  Â  Â  Â  clearTimeout(responseTimeout);
Â  Â  Â  Â  Â  Â  handleTurnComplete();
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  topicForm.addEventListener('submit', async function(e) {
Â  Â  Â  Â  Â  // Prevent the default form submission behavior
Â  Â  Â  Â  Â  e.preventDefault();

Â  Â  Â  Â  Â  // Check if a session ID already exists. If not, create one.
Â  Â  Â  Â  Â  if (!sessionId) {
Â  Â  Â  Â  Â  Â  Â  sessionId = crypto.randomUUID();
Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('sessionId', sessionId);
Â  Â  Â  Â  Â  Â  Â  const newUrl = `${window.location.pathname}?session=${sessionId}`;
Â  Â  Â  Â  Â  Â  Â  window.history.pushState({ path: newUrl }, '', newUrl);

Â  Â  Â  Â  Â  Â  Â  // ğŸ”¥ CRITICAL FIX: Tell the server to join the new session room
Â  Â  Â  Â  Â  Â  Â  socket.emit('joinSession', sessionId);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  // Now that the session ID is guaranteed to be in the URL,
Â  Â  Â  Â  Â  // the rest of the logic can proceed as before.
Â  Â  Â  Â  Â  const alphaViewURL = `${location.origin}/ai-debate/alphaView?session=${sessionId}`;
Â  Â  Â  Â  Â  const betaViewURL = `${location.origin}/ai-debate/betaView?session=${sessionId}`;
Â  Â  Â  Â  Â  document.getElementById('alphaLink').value = alphaViewURL;
Â  Â  Â  Â  Â  document.getElementById('betaLink').value = betaViewURL;
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  topic = topicInput.value.trim();
Â  Â  Â  Â  Â  alphaName = alphaNameInput.value.trim() || 'Alpha';
Â  Â  Â  Â  Â  betaName = betaNameInput.value.trim() || 'Beta';
Â  Â  Â  Â  Â  rounds = parseInt(document.getElementById('roundsInput').value) || 3;
Â  Â  Â  Â  Â  maxSteps = rounds * 2;
Â  Â  Â  Â  Â  debateTitle.innerHTML = `GroBattle: <span id="alphaName">${alphaName}</span> vs <span id="betaName">${betaName}</span> â€” <span id="debateTopic">${topic}</span>`;
Â  Â  Â  Â  Â  alphaNameSpan.textContent = alphaName;
Â  Â  Â  Â  Â  betaNameSpan.textContent = betaName;
Â  Â  Â  Â  Â  alphaNameSpan2.textContent = alphaName;
Â  Â  Â  Â  Â  betaNameSpan2.textContent = betaName;
Â  Â  Â  Â  Â  debateTopicSpan.textContent = topic;
Â  Â  Â  Â  Â  alphaTitle.textContent = `${alphaName} (Pro)`;
Â  Â  Â  Â  Â  betaTitle.textContent = `${betaName} (Con)`;
Â  Â  Â  Â  Â  alphaAvatar.title = alphaName;
Â  Â  Â  Â  Â  betaAvatar.title = betaName;
Â  Â  Â  Â  Â  alphaTurns.innerHTML = '';
Â  Â  Â  Â  Â  betaTurns.innerHTML = '';
Â  Â  Â  Â  Â  winnerBox.style.display = 'none';
Â  Â  Â  Â  Â  history = [];
Â  Â  Â  Â  Â  step = 0;
Â  Â  Â  Â  Â  stopped = false;
Â  Â  Â  Â  Â  broadcastStateUpdate();
Â  Â  Â  Â  Â  setDebateStatus('Debate is configured. Waiting for debaters to connect...');
Â  Â  Â  Â  Â  startBtn.disabled = true;
Â  Â  Â  Â  Â  stopBtn.disabled = true;
Â  Â  Â  Â  Â  alphaDebater.classList.remove('speaking');
Â  Â  Â  Â  Â  betaDebater.classList.remove('speaking');
Â  Â  Â  Â  Â  updateRoundIndicator();
Â  Â  Â  Â  Â  reflectionTurns.innerHTML = '';
Â  Â  Â  Â  Â  document.getElementById('alphaAvatarIcon').style.display = 'block';
Â  Â  Â  Â  Â  document.getElementById('alphaAvatarGif').style.display = 'none';
Â  Â  Â  Â  Â  document.getElementById('betaAvatarIcon').style.display = 'block';
Â  Â  Â  Â  Â  document.getElementById('betaAvatarGif').style.display = 'none';
Â  Â  Â  Â  Â  const explanationDiv = document.getElementById('topicExplanation');
Â  Â  Â  Â  Â  explanationDiv.style.display = 'block';
Â  Â  Â  Â  Â  explanationDiv.textContent = 'Loading topic explanation...';
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  const res = await fetch('/ai-debate/explain', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ topic })
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  if (data && data.explanation) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  explanationDiv.textContent = data.explanation;
Â  Â  Â  Â  Â  Â  Â  Â  Â  if ('speechSynthesis' in window) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const utter = new SpeechSynthesisUtterance(data.explanation);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  utter.rate = 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  utter.pitch = 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  utter.lang = 'en-US';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  utter.onend = function() {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  utter.onerror = function() {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.speechSynthesis.speak(utter);
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  explanationDiv.textContent = 'Could not fetch topic explanation.';
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  explanationDiv.textContent = 'Could not fetch topic explanation.';
Â  Â  Â  Â  Â  }
Â  Â  Â  });


Â  Â  Â  Â  async function handleTurnComplete() {
Â  Â  Â  Â  Â  Â  step++;
Â  Â  Â  Â  Â  Â  updateRoundIndicator();

Â  Â  Â  Â  Â  Â  if (step % 2 === 0 && step < maxSteps) {
Â  Â  Â  Â  Â  Â  Â  Â  // End of a round: fetch and show subtopics
Â  Â  Â  Â  Â  Â  Â  Â  isDebatePaused = true;
Â  Â  Â  Â  Â  Â  Â  Â  const subtopics = await fetchSubtopics(topic);
Â  Â  Â  Â  Â  Â  Â  Â  if (subtopics.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showSubtopicModal(subtopics);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return; // Wait for user to pick one before continuing
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (step < maxSteps && !stopped) {
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(fetchStep, 500);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  setDebateStatus('Debate finished!');
Â  Â  Â  Â  Â  Â  Â  Â  topicInput.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  startBtn.disabled = true; // Stay disabled after a full debate until a new one is configured
Â  Â  Â  Â  Â  Â  Â  Â  stopBtn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  getDebateWinner();
Â  Â  Â  Â  Â  Â  Â  Â  alphaDebater.classList.remove('speaking');
Â  Â  Â  Â  Â  Â  Â  Â  betaDebater.classList.remove('speaking');
Â  Â  Â  Â  Â  Â  Â  Â  updateRoundIndicator();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function fetchSubtopics(currentTopic) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch('/ai-debate/subtopics', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ topic: currentTopic })
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  return data.subtopics || [];
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error fetching subtopics:', e);
Â  Â  Â  Â  Â  Â  Â  Â  return [];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleSubtopicChoice(selected) {
Â  Â  Â  Â  Â  Â  newTopic = selected;
Â  Â  Â  Â  Â  Â  isDebatePaused = false;

Â  Â  Â  Â  Â  Â  topic = selected;
Â  Â  Â  Â  Â  Â  debateTopicSpan.textContent = topic;
Â  Â  Â  Â  Â  Â  debateTopicSpan.style.transition = 'background 0.3s, color 0.3s';
Â  Â  Â  Â  Â  Â  debateTopicSpan.style.background = '#a78bfa';
Â  Â  Â  Â  Â  Â  debateTopicSpan.style.color = '#fff';
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  debateTopicSpan.style.background = '';
Â  Â  Â  Â  Â  Â  Â  Â  debateTopicSpan.style.color = '';
Â  Â  Â  Â  Â  Â  }, 800);

Â  Â  Â  Â  Â  Â  if (step % 2 !== 0) step++;

Â  Â  Â  Â  Â  Â  fetchStep();
Â  Â  Â  Â  }

Â  Â  Â  Â  function showSubtopicModal(subtopics) {
Â  Â  Â  Â  Â  Â  const modal = document.getElementById('subtopicModal');
Â  Â  Â  Â  Â  Â  const list = document.getElementById('subtopicList');
Â  Â  Â  Â  Â  Â  list.innerHTML = '';

Â  Â  Â  Â  Â  Â  subtopics.forEach(topic => {
Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  btn.className = 'subtopic-btn';
Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = topic.text || topic;
Â  Â  Â  Â  Â  Â  Â  Â  btn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modal.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleSubtopicChoice(topic.text || topic);
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  list.appendChild(btn);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  modal.style.display = 'flex';
Â  Â  Â  Â  }

Â  Â  Â  Â  function setDebateStatus(text) {
Â  Â  Â  Â  Â  Â  statusDiv.textContent = text;
Â  Â  Â  Â  }

Â  Â  Â  Â  function showLoader(show, label) {
Â  Â  Â  Â  Â  Â  centerLoader.style.display = show ? 'flex' : 'none';
Â  Â  Â  Â  Â  Â  loaderLabel.textContent = label || 'AI is thinking...';
Â  Â  Â  Â  }

Â  Â  Â  Â  function showWinner() {
Â  Â  Â  Â  Â  Â  const winner = Math.random() < 0.5 ? `ğŸ† Winner: ${alphaName} (Pro)` : `ğŸ† Winner: ${betaName} (Con)`;
Â  Â  Â  Â  Â  Â  winnerBox.textContent = winner;
Â  Â  Â  Â  Â  Â  winnerBox.style.display = 'block';
Â  Â  Â  Â  Â  Â  playSound('winner');
Â  Â  Â  Â  Â  Â  launchConfetti();
Â  Â  Â  Â  }

Â  Â  Â  Â  function setSpeakingDebater(isAlpha) {
Â  Â  Â  Â  Â  Â  if (isAlpha) {
Â  Â  Â  Â  Â  Â  Â  Â  alphaDebater.classList.add('speaking');
Â  Â  Â  Â  Â  Â  Â  Â  betaDebater.classList.remove('speaking');
Â  Â  Â  Â  Â  Â  Â  Â  playSound('turn');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('alphaAvatarIcon').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('alphaAvatarGif').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('betaAvatarIcon').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('betaAvatarGif').style.display = 'none';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  betaDebater.classList.add('speaking');
Â  Â  Â  Â  Â  Â  Â  Â  alphaDebater.classList.remove('speaking');
Â  Â  Â  Â  Â  Â  Â  Â  playSound('turn');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('betaAvatarIcon').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('betaAvatarGif').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('alphaAvatarIcon').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('alphaAvatarGif').style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateRoundIndicator() {
Â  Â  Â  Â  Â  Â  const currentRound = Math.floor(step / 2) + 1;
Â  Â  Â  Â  Â  Â  const totalRounds = rounds;
Â  Â  Â  Â  Â  Â  if (step < maxSteps) {
Â  Â  Â  Â  Â  Â  Â  Â  roundIndicator.textContent = `Round ${currentRound} of ${totalRounds}`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  roundIndicator.textContent = 'Reflection';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function fetchStep() {
Â  Â  Â  Â  Â  Â  if (stopped) return;
Â  Â  Â  Â  Â  Â  if (isDebatePaused) return;

Â  Â  Â  Â  Â  Â  if (newTopic) {
Â  Â  Â  Â  Â  Â  Â  Â  topic = newTopic;
Â  Â  Â  Â  Â  Â  Â  Â  debateTopicSpan.textContent = topic;
Â  Â  Â  Â  Â  Â  Â  Â  newTopic = null;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const isAlpha = step % 2 === 0;
Â  Â  Â  Â  Â  Â  setDebateStatus((isAlpha ? alphaName : betaName) + ' is speaking...');
Â  Â  Â  Â  Â  Â  setSpeakingDebater(isAlpha);
Â  Â  Â  Â  Â  Â  showLoader(true, (isAlpha ? alphaName : betaName) + ' is thinking...');
Â  Â  Â  Â  Â  Â  updateRoundIndicator();

Â  Â  Â  Â  Â  Â  const res = await fetch('/ai-debate/step', {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ topic, history, step, alphaName, betaName, rounds })
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  showLoader(false);
Â  Â  Â  Â  Â  Â  if (data && data.text) {
Â  Â  Â  Â  Â  Â  Â  Â  console.log('Debate turn text:', data.text);
Â  Â  Â  Â  Â  Â  Â  Â  if (isAlpha && alphaWindow) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alphaWindow.postMessage({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: 'alphaTurn', // Fixed from 'alphaTurns'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: data.text,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alphaName
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, '*');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responseTimeout = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('AI response timeout â€” forcing next turn.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleTurnComplete();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 30000);
Â  Â  Â  Â  Â  Â  Â  Â  } 
Â  Â  Â  Â  Â  Â  Â  Â  else if (betaWindow && !isAlpha) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  betaWindow.postMessage({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: 'betaTurn',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: data.text,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  step,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  betaName
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, '*');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responseTimeout = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('AI response timeout â€” forcing next turn.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleTurnComplete();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 30000);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  history.push({ role: 'assistant', content: data.text });
Â  Â  Â  Â  Â  Â  Â  Â  broadcastStateUpdate();
Â  Â  Â  Â  Â  Â  Â  Â  const progress = Math.min((step + 1) / maxSteps, 1);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('debateProgressBar').style.width = (progress * 100) + '%';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  setDebateStatus('Error: Could not get response.');
Â  Â  Â  Â  Â  Â  Â  Â  startBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  stopBtn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  getDebateWinner();
Â  Â  Â  Â  Â  Â  Â  Â  alphaDebater.classList.remove('speaking');
Â  Â  Â  Â  Â  Â  Â  Â  betaDebater.classList.remove('speaking');
Â  Â  Â  Â  Â  Â  Â  Â  updateRoundIndicator();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function getDebateWinner() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch('/ai-debate/judge', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alphaName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  betaName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transcript: history.map(h => h.content),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  topic
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  if (data && data.winner) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  winnerBox.textContent = `ğŸ† Winner: ${data.winner}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  winnerBox.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  playSound('winner');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  launchConfetti();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('winnerModalTitle').textContent = `ğŸ† Winner: ${data.winner}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('winnerModalReason').textContent = data.reason ? `Why: ${data.reason}` : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let ratingsHtml = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.ratings) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ratingsHtml = 'Ratings:';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const [name, rating] of Object.entries(data.ratings)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ratingsHtml += `<br><span style='color:#fff;'>${name}:</span> ${rating}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('winnerModalRatings').innerHTML = ratingsHtml;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('winnerModal').style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('closeWinnerModal').onclick = function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('winnerModal').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  winnerBox.textContent = 'ğŸ† Winner: Could not determine.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  winnerBox.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  winnerBox.textContent = 'ğŸ† Winner: Could not determine.';
Â  Â  Â  Â  Â  Â  Â  Â  winnerBox.style.display = 'block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  function openAlpha() {
Â  Â  Â  Â  Â  Â  alphaWindow = window.open(`/ai-debate/alphaView?session=${sessionId}`, 'alphaWindow');
Â  Â  Â  Â  }

Â  Â  Â  Â  function openBeta() {
Â  Â  Â  Â  Â  Â  betaWindow = window.open(`/ai-debate/betaView?session=${sessionId}`, 'betaWindow');
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  startBtn.addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  if (!alphaReady || !betaReady) {
Â  Â  Â  Â  Â  Â  Â  Â  setDebateStatus('Please open both Alpha and Beta views and click "Join Debate" before starting.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const isRestart = (history.length === 0);

Â  Â  Â  Â  Â  Â  startBtn.disabled = true;
Â  Â  Â  Â  Â  Â  stopBtn.disabled = false;

Â  Â  Â  Â  Â  Â  if (isRestart) {
Â  Â  Â  Â  Â  Â  Â  Â  alphaTurns.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  betaTurns.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  winnerBox.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  history = [];
Â  Â  Â  Â  Â  Â  Â  Â  step = 0;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  stopped = false;
Â  Â  Â  Â  Â  Â  setDebateStatus('');
Â  Â  Â  Â  Â  Â  document.getElementById('debateProgressBar').style.width = `${(step / (rounds * 2)) * 100}%`;
Â  Â  Â  Â  Â  Â  updateRoundIndicator();
Â  Â  Â  Â  Â  Â  reflectionTurns.innerHTML = '';

Â  Â  Â  Â  Â  Â  document.getElementById('topicExplanation').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('alphaAvatarIcon').style.display = 'block';
Â  Â  Â  Â  Â  Â  document.getElementById('alphaAvatarGif').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('betaAvatarIcon').style.display = 'block';
Â  Â  Â  Â  Â  Â  document.getElementById('betaAvatarGif').style.display = 'none';

Â  Â  Â  Â  Â  Â  rounds = parseInt(document.getElementById('roundsInput').value) || 3;
Â  Â  Â  Â  Â  Â  maxSteps = rounds * 2;
Â  Â  Â  Â  Â  Â  topicInput.disabled = true;
Â  Â  Â  Â  Â  Â  fetchStep();
Â  Â  Â  Â  });

Â  Â  Â  Â  stopBtn.addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  stopped = true;
Â  Â  Â  Â  Â  Â  setDebateStatus('Debate stopped.');
Â  Â  Â  Â  Â  Â  topicInput.disabled = false;
Â  Â  Â  Â  Â  Â  startBtn.disabled = false;
Â  Â  Â  Â  Â  Â  stopBtn.disabled = true;
Â  Â  Â  Â  Â  Â  showLoader(false);
Â  Â  Â  Â  Â  Â  showWinner();
Â  Â  Â  Â  Â  Â  alphaDebater.classList.remove('speaking');
Â  Â  Â  Â  Â  Â  betaDebater.classList.remove('speaking');
Â  Â  Â  Â  Â  Â  updateRoundIndicator();
Â  Â  Â  Â  });
Â  Â  Â  Â  const resetBtn = document.getElementById('resetDebateBtn');
Â  Â  Â  Â  resetBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  step = 0;
Â  Â  Â  Â  Â  Â  stopped = true;
Â  Â  Â  Â  Â  Â  history = [];
Â  Â  Â  Â  Â  Â  rounds = 3;
Â  Â  Â  Â  Â  Â  maxSteps = rounds * 2;
Â  Â  Â  Â  Â  Â  newTopic = null;
Â  Â  Â  Â  Â  Â  isDebatePaused = false;
Â  Â  Â  Â  Â  Â  sessionRestored = false;
Â  Â  Â  Â  Â  Â  document.getElementById('roundsInput').value = '3';
Â  Â  Â  Â  Â  Â  topicInput.disabled = false;
Â  Â  Â  Â  Â  Â  topicInput.value = '';
Â  Â  Â  Â  Â  Â  alphaNameInput.disabled = false;
Â  Â  Â  Â  Â  Â  betaNameInput.disabled = false;
Â  Â  Â  Â  Â  Â  alphaNameInput.value = '';
Â  Â  Â  Â  Â  Â  betaNameInput.value = '';
Â  Â  Â  Â  Â  Â  debateTopicSpan.textContent = '';
Â  Â  Â  Â  Â  Â  debateTitle.innerHTML = '';
Â  Â  Â  Â  Â  Â  socket.emit('resetSession', sessionId);
Â  Â  Â  Â  Â  Â  winnerBox.style.display = 'none';
Â  Â  Â  Â  Â  Â  alphaTurns.innerHTML = '';
Â  Â  Â  Â  Â  Â  betaTurns.innerHTML = '';
Â  Â  Â  Â  Â  Â  reflectionTurns.innerHTML = '';
Â  Â  Â  Â  Â  Â  document.getElementById('debateProgressBar').style.width = '0%';
Â  Â  Â  Â  Â  Â  document.getElementById('winnerModal').style.display = 'none';
Â  Â  Â  Â  Â  Â  document.getElementById('topicExplanation').style.display = 'none';
Â  Â  Â  Â  Â  Â  setDebateStatus('Debate reset. Ready to begin a new one.');
Â  Â  Â  Â  Â  Â  localStorage.removeItem('sessionId');
Â  Â  Â  Â  Â  Â  sessionId = null;
Â  Â  Â  Â  });

Â  Â  Â  Â  topicInput.setAttribute('aria-label', 'Debate topic');
Â  Â  Â  Â  alphaNameInput.setAttribute('aria-label', 'Alpha debater name');
Â  Â  Â  Â  betaNameInput.setAttribute('aria-label', 'Beta debater name');
Â  Â  Â  Â  startBtn.setAttribute('aria-label', 'Start Debate');
Â  Â  Â  Â  stopBtn.setAttribute('aria-label', 'Stop Debate');
Â  Â  Â  Â  topicForm.setAttribute('aria-label', 'Debate configuration form');

Â  Â  Â  Â  function showWelcomeBanner() {
Â  Â  Â  Â  Â  Â  const banner = document.getElementById('welcomeBanner');
Â  Â  Â  Â  Â  Â  banner.style.display = 'block';
Â  Â  Â  Â  Â  Â  document.getElementById('closeWelcomeBanner').onclick = function() {
Â  Â  Â  Â  Â  Â  Â  Â  banner.style.display = 'none';
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  Â  Â  function showWelcomeGif() {
Â  Â  Â  Â  Â  Â  document.getElementById('welcomeGifContainer').style.display = 'block';
Â  Â  Â  Â  }
Â  Â  Â  Â  function hideWelcomeGif() {
Â  Â  Â  Â  Â  Â  document.getElementById('welcomeGifContainer').style.display = 'none';
Â  Â  Â  Â  }
Â  Â  Â  Â  function trySpeakWelcome() {
Â  Â  Â  Â  Â  Â  if ('speechSynthesis' in window && document.hasFocus()) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.speechSynthesis.cancel();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const welcome = new SpeechSynthesisUtterance('Welcome to Debate. Experience a live, intelligent debate on any topic you choose.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  welcome.rate = 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  welcome.pitch = 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  welcome.lang = 'en-US';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showWelcomeGif();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.speechSynthesis.speak(welcome);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  welcome.onend = function() { hideWelcomeGif(); };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  welcome.onerror = function() { showWelcomeBanner(); hideWelcomeGif(); };
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showWelcomeBanner();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showWelcomeGif();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(hideWelcomeGif, 3500);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  showWelcomeBanner();
Â  Â  Â  Â  Â  Â  Â  Â  showWelcomeGif();
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(hideWelcomeGif, 3500);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  let welcomeSpoken = false;
Â  Â  Â  Â  function speakWelcome() {
Â  Â  Â  Â  Â  Â  if (welcomeSpoken) return;
Â  Â  Â  Â  Â  Â  welcomeSpoken = true;
Â  Â  Â  Â  Â  Â  trySpeakWelcome();
Â  Â  Â  Â  Â  Â  window.removeEventListener('click', speakWelcome);
Â  Â  Â  Â  Â  Â  window.removeEventListener('keydown', speakWelcome);
Â  Â  Â  Â  Â  Â  window.removeEventListener('focus', speakWelcome, true);
Â  Â  Â  Â  }
Â  Â  Â  Â  window.addEventListener('click', speakWelcome);
Â  Â  Â  Â  window.addEventListener('keydown', speakWelcome);
Â  Â  Â  Â  window.addEventListener('focus', speakWelcome, true);

Â  Â  Â  Â  const sounds = {
Â  Â  Â  Â  Â  Â  turn: new Audio('https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae5b2.mp3'),
Â  Â  Â  Â  Â  Â  winner: new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_115b9b7b7b.mp3'),
Â  Â  Â  Â  };
Â  Â  Â  Â  function playSound(type) {
Â  Â  Â  Â  Â  Â  if (sounds[type]) {
Â  Â  Â  Â  Â  Â  Â  Â  sounds[type].currentTime = 0;
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sounds[type].play();
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  function launchConfetti() {
Â  Â  Â  Â  Â  Â  const canvas = document.getElementById('confettiCanvas');
Â  Â  Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  Â  Â  const W = window.innerWidth;
Â  Â  Â  Â  Â  Â  const H = 120;
Â  Â  Â  Â  Â  Â  canvas.width = W;
Â  Â  Â  Â  Â  Â  canvas.height = H;
Â  Â  Â  Â  Â  Â  const confettiCount = 60;
Â  Â  Â  Â  Â  Â  const confetti = [];
Â  Â  Â  Â  Â  Â  for (let i = 0; i < confettiCount; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  confetti.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x: Math.random() * W,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y: Math.random() * H * 0.5,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  r: 6 + Math.random() * 8,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  d: 10 + Math.random() * 20,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: `hsl(${Math.random()*360},80%,70%)`,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tilt: Math.random() * 10 - 5,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tiltAngle: 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tiltAngleInc: (Math.random() * 0.07) + 0.05
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  let frame = 0;
Â  Â  Â  Â  Â  Â  function draw() {
Â  Â  Â  Â  Â  Â  Â  Â  ctx.clearRect(0, 0, W, H);
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < confetti.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const c = confetti[i];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.ellipse(c.x, c.y, c.r, c.r*0.4, c.tilt, 0, 2 * Math.PI);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = c.color;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fill();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  update();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function update() {
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < confetti.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const c = confetti[i];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  c.y += Math.cos(frame/10 + c.d) + 1 + c.r/4;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  c.x += Math.sin(frame/20) * 2;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  c.tiltAngle += c.tiltAngleInc;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  c.tilt = Math.sin(c.tiltAngle) * 15;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (c.y > H) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  c.x = Math.random() * W;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  c.y = -10;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  frame++;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  let anim = setInterval(draw, 16);
Â  Â  Â  Â  Â  Â  setTimeout(() => { clearInterval(anim); ctx.clearRect(0,0,W,H); }, 1800);
Â  Â  Â  Â  }

Â  Â  Â  Â  socket.on('sessionState', (data) => {
Â  Â  Â  Â  Â  Â  if (!sessionRestored) {
Â  Â  Â  Â  Â  Â  Â  Â  sessionRestored = true;

Â  Â  Â  Â  Â  Â  Â  Â  if (data.topic) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  topic = data.topic;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  topicInput.value = topic;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  debateTopicSpan.textContent = topic;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (data.alphaName) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alphaName = data.alphaName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alphaNameInput.value = alphaName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alphaNameSpan.textContent = alphaName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alphaNameSpan2.textContent = alphaName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alphaTitle.textContent = `${alphaName} (Pro)`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alphaAvatar.title = alphaName;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (data.betaName) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  betaName = data.betaName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  betaNameInput.value = betaName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  betaNameSpan.textContent = betaName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  betaNameSpan2.textContent = betaName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  betaTitle.textContent = `${betaName} (Con)`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  betaAvatar.title = betaName;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (data.rounds) rounds = data.rounds;
Â  Â  Â  Â  Â  Â  Â  Â  if (data.maxSteps) maxSteps = data.maxSteps;
Â  Â  Â  Â  Â  Â  Â  Â  if (data.step !== undefined) step = data.step;
Â  Â  Â  Â  Â  Â  Â  Â  if (data.history) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  history = data.history;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alphaTurns.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  betaTurns.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  history.forEach((h, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  div.textContent = h.content;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (index % 2 === 0) alphaTurns.appendChild(div);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else betaTurns.appendChild(div);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  updateRoundIndicator();

Â  Â  Â  Â  Â  Â  Â  Â  if (step > 0 && step < maxSteps && isModerator) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const resume = confirm("Resume previous debate?");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (resume) fetchStep();
Â  Â  Â  Â  Â  Â  Â  Â  } else if (step >= maxSteps) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setDebateStatus('Debate finished!');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showWinner();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  socket.on('sessionUpdated', (data) => {
Â  Â  Â  Â  Â  Â  if (data.topic) topicInput.value = data.topic;
Â  Â  Â  Â  Â  Â  if (data.alphaName) alphaNameInput.value = data.alphaName;
Â  Â  Â  Â  Â  Â  if (data.betaName) betaNameInput.value = data.betaName;
Â  Â  Â  Â  Â  Â  if (data.step !== undefined) step = data.step;
Â  Â  Â  Â  Â  Â  if (data.rounds !== undefined) rounds = data.rounds;
Â  Â  Â  Â  Â  Â  if (data.maxSteps !== undefined) maxSteps = data.maxSteps;
Â  Â  Â  Â  Â  Â  if (data.history) {
Â  Â  Â  Â  Â  Â  Â  Â  const newTurn = data.history[data.history.length - 1];
Â  Â  Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  div.textContent = newTurn.content;
Â  Â  Â  Â  Â  Â  Â  Â  if (data.history.length % 2 === 1) betaTurns.appendChild(div);
Â  Â  Â  Â  Â  Â  Â  Â  else alphaTurns.appendChild(div);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  function broadcastStateUpdate() {
Â  Â  Â  Â  Â  Â  socket.emit('updateState', {
Â  Â  Â  Â  Â  Â  Â  Â  sessionId,
Â  Â  Â  Â  Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  topic,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alphaName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  betaName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rounds,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  maxSteps,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  step,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  history
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function copyLink(role) {
Â  Â  Â  Â  Â  Â  const input = role === 'alpha'
Â  Â  Â  Â  Â  Â  Â  Â  ? document.getElementById('alphaLink')
Â  Â  Â  Â  Â  Â  Â  Â  : document.getElementById('betaLink');

Â  Â  Â  Â  Â  Â  navigator.clipboard.writeText(input.value).then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  const status = document.getElementById(role + 'Status');
Â  Â  Â  Â  Â  Â  Â  Â  status.textContent = 'âœ… Link copied!';
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status.textContent = status.dataset.connected === 'true' ? `âœ… ${capitalize(role)} connected` : 'âŒ Not connected';
Â  Â  Â  Â  Â  Â  Â  Â  }, 1500);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  input.setSelectionRange(0, 99999);
Â  Â  Â  Â  Â  Â  document.execCommand('copy');

Â  Â  Â  Â  Â  Â  const status = document.getElementById(role + 'Status');
Â  Â  Â  Â  Â  Â  status.textContent = 'âœ… Link copied!';
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  status.textContent = status.dataset.connected === 'true' ? `âœ… ${capitalize(role)} connected` : 'âŒ Not connected';
Â  Â  Â  Â  Â  Â  }, 1500);
Â  Â  Â  Â  }

Â  Â  Â  Â  function capitalize(word) {
Â  Â  Â  Â  Â  Â  return word.charAt(0).toUpperCase() + word.slice(1);
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>